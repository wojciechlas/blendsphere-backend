# PocketBase Schema Import Guide

This guide provides detailed instructions for importing the BlendSphere database schema into PocketBase admin dashboard.

## üöÄ Quick Import (Recommended)

### Option 1: File Upload Method

1. **Start PocketBase**:
   ```bash
   ./run_pocketbase.sh
   ```

2. **Access Admin Dashboard**:
   - Open http://127.0.0.1:8090/_/
   - Create admin account when prompted

3. **Import Schema**:
   - Click **Settings** (‚öôÔ∏è) ‚Üí **Import collections**
   - Click **Choose file**
   - Select: `pb_migrations/consolidated_schema.json`
   - Click **Review import** 
   - Verify 21 collections are listed
   - Click **Import**

### Option 2: Copy-Paste Method

1. **Copy Schema Content**:
   ```bash
   cat pb_migrations/consolidated_schema.json
   ```

2. **Import via Dashboard**:
   - **Settings** ‚Üí **Import collections**
   - Click **Load from JSON**
   - Paste the JSON content
   - Click **Review import**
   - Click **Import**

## üîß Manual Individual Import

If the consolidated import fails, import collections individually in this **exact order**:

### Step 1: System Collections
```
1. _authOrigins.json
2. _superusers.json
```

### Step 2: Base Collections
```
3. users.json              # Required for all user relations
4. templates.json          # Template definitions
5. aiPrompts.json          # AI prompt templates
```

### Step 3: Core Collections
```
6. fields.json             # Template field definitions
7. classes.json            # Teacher classes
```

### Step 4: Relation Collections
```
8. classEnrollments.json   # Creates classEnrollments_via_class back relation
```
> **‚ö†Ô∏è IMPORTANT**: This collection must be imported before any collection that uses `classEnrollments_via_class` in their access rules.

### Step 5: Dependent Collections
```
9. decks.json              # Flashcard decks
10. lessons.json           # Class lessons  
11. posts.json             # Community posts
```

### Step 6: Advanced Collections
```
12. flashcards.json        # Individual flashcards
13. studySessions.json     # Study session tracking
14. comments.json          # Post comments
15. reactions.json         # User reactions
16. flashcardReviews.json  # Card review history
```

## ‚ùå Common Import Errors & Solutions

### Error: "failed to load back relation field 'enrollments_via_class'"

**Cause**: Collections are being imported out of order.

**Solution**: 
1. Import `classEnrollments.json` first
2. Then import collections that reference `classEnrollments_via_class`

**Fixed in**: May 2025 - schema files now use correct `classEnrollments_via_class` name

### Error: "invalid left operand 'enrollments_via_class'"

**Cause**: Using old schema files with incorrect back relation names.

**Solution**:
```bash
# Regenerate schema with latest fixes
cd pb_migrations
./consolidate_schema.sh
```

### Error: "Collection validation failed"

**Cause**: Invalid JSON or unsupported field types.

**Solution**:
```bash
# Validate JSON syntax
cat pb_migrations/consolidated_schema.json | jq . > /dev/null

# Check file size (should be ~50KB+)
ls -lh pb_migrations/consolidated_schema.json

# Regenerate if corrupted
./consolidate_schema.sh
```

### Error: "Access rule validation failed"

**Cause**: Rules reference collections that don't exist yet.

**Solution**:
1. Import collections in dependency order (see manual import above)
2. Or temporarily remove access rules during import, then add them back

### Error: "File not found"

**Cause**: Wrong directory or missing files.

**Solution**:
```bash
# Ensure you're in the right directory
pwd  # Should end with /src/pocketbase

# Check file exists
ls -la pb_migrations/consolidated_schema.json

# Generate if missing
cd pb_migrations && ./consolidate_schema.sh
```

## üîç Verification Steps

After import, verify everything worked:

1. **Check Collection Count**:
   - Go to **Collections** tab
   - Should see 21 collections total

2. **Test API Access**:
   ```bash
   curl http://127.0.0.1:8090/api/health
   ```

3. **Run Verification Script**:
   ```bash
   ./verify_setup.sh
   ```

4. **Check Sample Collections**:
   - Click on `users` collection
   - Verify fields: email, name, avatar, etc.
   - Click on `classes` collection  
   - Verify fields: name, teacher, code, etc.

## üìã Schema File Information

### Consolidated Schema
- **File**: `pb_migrations/consolidated_schema.json`
- **Size**: ~50KB
- **Collections**: 21 total
- **Last Updated**: May 25, 2025
- **Generated by**: `./consolidate_schema.sh`

### Individual Collections  
- **Directory**: `pb_migrations/collections/`
- **Count**: 17 files (21 total collections including system)
- **Format**: One JSON file per collection

## üõ†Ô∏è Advanced Options

### Rebuild Consolidated Schema
```bash
cd pb_migrations
./consolidate_schema.sh
```

### Import Specific Collection
```bash
# Copy content from individual file
cat pb_migrations/collections/classes.json

# Paste in: Collections ‚Üí + New collection ‚Üí Import from JSON
```

### Export Current Schema
```bash
# In PocketBase admin: Settings ‚Üí Export collections
# Download and compare with your local files
```

### Reset and Re-import
```bash
# DANGER: This deletes all data
rm -rf pb_data
./run_pocketbase.sh  # Creates fresh database
# Then re-import schema
```

## üìû Support

- **Documentation**: See [README.md](README.md) for complete setup guide
- **Quick Start**: See [QUICK_START.md](QUICK_START.md) for fastest setup
- **PocketBase Docs**: https://pocketbase.io/docs/
- **API Reference**: http://127.0.0.1:8090/_/#/docs (when running)

## ‚úÖ Success Checklist

- [ ] PocketBase starts without errors
- [ ] Admin dashboard accessible at http://127.0.0.1:8090/_/
- [ ] 21 collections imported successfully
- [ ] No validation errors in collections
- [ ] API health check returns OK
- [ ] Frontend can connect to database

---

**üéâ Import Complete!** Your BlendSphere database is ready for development.
